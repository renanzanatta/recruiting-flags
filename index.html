async function callSearch({ test=false } = {}){
  const role = $("qRole").value.trim();
  const loc  = $("qLocation").value.trim();
  const name = $("qName").value.trim();
  const extra= $("qExtra").value.trim();
  const emojis = getSelectedEmojis();

  if (!test && !(role || loc || name || extra)) {
    setStatus("Preencha pelo menos um campo para buscar.", "warn");
    return;
  }

  clearStatus();
  renderResults([]);
  countBadge.textContent = "…";
  setStatus("Buscando…");

  const payload = test
    ? { role: "Creative Director", location: "São Paulo", name: "Clarissa Astigarraga", extra: "iDTBWA", emojis }
    : { role, location: loc, name, extra, emojis };

  try{
    const res = await fetch("/api/search", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const data = await res.json();

    if (!res.ok){
      setStatus("Erro do endpoint (" + res.status + "):\n\n" + (data?.error || "Erro desconhecido"), "err");
      renderResults([]);
      countBadge.textContent = "0";
      return;
    }

    const items = data.items || [];
    const strategy = data.strategyUsed ? `\nEstratégia: ${data.strategyUsed}` : "";
    const note = data.note ? `\n\n${data.note}` : "";

    setStatus(`✅ OK\nResultados: ${items.length}${strategy}${note}`);
    renderResults(items);

    if (!items.length){
      setStatus(
        "Nenhum resultado.\n\nDicas:\n- tente apenas Nome\n- tente remover local/extra\n- desmarque emojis para validar se o nome aparece sem filtro",
        "warn"
      );
    }
  }catch(e){
    setStatus("Erro ao chamar /api/search:\n\n" + (e?.message || e), "err");
    renderResults([]);
    countBadge.textContent = "0";
  }
}
